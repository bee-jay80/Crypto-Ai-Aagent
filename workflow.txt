{
  "active": true,
  "category": "crypto",
  "description": "Crypto AI Agent that gives crypto prices & history",
  "name": "crypto_price_agent",
  "long_description": "This agent reads crypto questions and returns price data, history, and market comparison.",
  "nodes": [
    {
      "id": "crypto_agent",
      "name": "Crypto Price Bot",
      "parameters": {
        "text": ""
      },
      "position": [
        800,
        -100
      ],
      "type": "a2a/generic-a2a-node",
      "typeVersion": 1,
      "url": "https://beejay.pythonanywhere.com/api/v1/a2a/crypto"
    }
  ],
  "settings": {
    "executionOrder": "v1"
  },
  "short_description": "crypto assets Analyzer"
}



"id": "sGC3u7y4vBaZww0G",



Views.py
import json
import httpx
from openai import OpenAI
from django.conf import settings

from datetime import datetime, timedelta
import dateparser

def normalize_date(date_text: str):
    if not date_text:
        return None
    
    # parse natural language (yesterday, 3 days ago, one week ago)
    dt = dateparser.parse(date_text)

    if not dt:
        return None

    return dt.strftime("%Y-%m-%d")

HF_TOKEN = getattr(settings, "HF_API_TOKEN", None)

if not HF_TOKEN:
    raise RuntimeError("HF_API_TOKEN missing in env")

client = OpenAI(
    base_url="https://router.huggingface.co/v1",
    api_key=HF_TOKEN
)

SYSTEM_PROMPT = """
You are a crypto assistant and command parser.

Primary functions:
1. When the user asks about cryptocurrency price/history/analysis/comparison â†’ return ONLY valid JSON.
2. If the message does NOT contain a crypto-related intent â†’ reply conversationally like a friendly assistant.
3. If user asks "what do you do" or "who are you" â†’ explain your role and how to request crypto data.
4. Detect greetings like "hi", "hello" and respond normally.
5. Always be friendly and normal in conversation mode.

CRYPTO MODE (Structured JSON rules):
- Detect crypto-related queries (price inquiry, compare, asset lookup, date reference)
- Extract correct asset name and symbol
- Convert natural dates to phrases usable for conversion (yesterday, 3 days ago, 1 week ago)
- NEVER include normal text around JSON
- Return only JSON like:
{"asset":"bitcoin","symbol":"BTC","date":"yesterday"}

If no date given, assume "today" and use JSON.

Chat Mode Examples (no JSON):
User: "Hi"
Response: "Hello! ðŸ‘‹ How can I help you today?"

User: "What do you do?"
Response: "I help you check cryptocurrency prices for any date. You can say things like:
- 'Check btc yesterday'
- 'Solana price 3 days ago'
- 'Compare ETH one week ago'"

User: "How's your day?"
Response: "Great! I'm ready to assist ðŸ˜Š"

Crypto Mode Examples (pure JSON):
User: "check btc yesterday"
Response:
{"asset":"bitcoin","symbol":"BTC","date":"yesterday"}

User: "ethereum price three days ago"
Response:
{"asset":"ethereum","symbol":"ETH","date":"3 days ago"}

User: "solana on 2025-12-31"
Response:
{"asset":"solana","symbol":"SOL","date":"2025-12-31"}

User: "compare eth price one week ago"
Response:
{"asset":"ethereum","symbol":"ETH","date":"1 week ago"}

REMEMBER:
- If crypto detected â†’ JSON only
- If normal chat â†’ normal text reply
- For unknown asset spelling, correct it intelligently
- Multi-word coins use hyphen (pi-network) except brand coins like pinksale (no hyphen)


Also give the right symbols and asset  for the right coins even the once not mentioned here
For a more than one word asset seperate by hyphine (-) e.g pi-network but asset like pink sale that is pinksale should not be with an hyphine(-)

Always try to format the asset even if the user passes a wrong spelling get the original asset from the matching words AND MAKE USE OF KEYWORDS THAT SHOULD BE A COIN e.g Hamaster coin= Hamster Kombat

TODAY is current date.
Return ONLY valid JSON like:
{"asset":"bitcoin","symbol":"BTC","date":"todays date"}

NOTE: do not actually return 2025-month in number-day in number but return it with the month as a number and also the date as a number also the updated year
"""

async def parse_text(text: str) -> dict:
    try:
        completion = client.chat.completions.create(
            model="zai-org/GLM-4.6:novita",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": text}
            ],
            max_tokens=200,
        )

        raw = completion.choices[0].message.content.strip()

        # âœ… Try JSON mode first
        try:
            data = json.loads(raw)
            parsed_date = normalize_date(data.get("date"))
            return {
                "asset": data.get("asset"),
                "symbol": data.get("symbol"),
                "date": parsed_date,
                "raw": raw
            }
        except json.JSONDecodeError:
            # âœ… Normal Chat Mode
            return {
                "message": raw,
                "mode": "chat"
            }

    except Exception as e:
        return {"error": "PARSE_FAILED", "details": str(e)}



SYSTEM_PROMPT2 = """
You are a professional cryptocurrency analysis assistant.

Your task:
- Receive data about a cryptocurrency including: asset name, symbol, date, and price.
- Provide a clear, concise, and insightful analysis.
- The tone should be professional, informative, simple, and beginner-friendly.

Your response must include:
1. A short summary of the asset and what it is known for
2. The date and price analyzed
3. Whether the price is rising, falling, or stagnant (based only on the data given â€” do NOT make up data)
4. Market sentiment words like: bullish, bearish, neutral (based only on the trend)
5. A caution note reminding users that crypto prices are volatile

Rules:
- Do not hallucinate price history or future predictions.
- Do not promise profits or financial returns.
- If data is missing or unclear, say it clearly.
- Never provide financial advice. Instead, give market insights and trends.
- Do not mention that you are an AI model.

Example output style (not literal):


Asset: Bitcoin (BTC)
Date checked: 2025-01-05
Price on date: $42,500
Current price: $45,300
Percentage change: 
Direction: "Increase"

Bitcoin remains the leading cryptocurrency known for secure, decentralized payments.
Based on the latest data, BTC appears to be trending slightly upward, suggesting moderate bullish sentiment.

As always, crypto markets are highly volatile â€” this is not financial advice, but a snapshot of current conditions.
"""
async def response_text(data: dict) -> dict:
    try:
        # data already is a dict, no need to json.loads
        formatted_user_input = json.dumps(data, ensure_ascii=False)

        completion = client.chat.completions.create(
            model="zai-org/GLM-4.6:novita",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT2},
                {"role": "user", "content": formatted_user_input}
            ],
            max_tokens=300,
        )

        return completion.choices[0].message.content.strip()

    except Exception as e:
        return {"error": "RESPONSE_FAILED", "details": str(e)}